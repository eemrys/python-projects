#!/usr/bin/env python3
import json
import os
import pickle
import pandas as pd
import numpy as np
from custom import Database

DEFAULT_MODEL_PATH = './models/DTC.pkl'
DEFAULT_DB_PATH = './storage/log.db'

def main():
    print('Send json string to get prediction.')
    print('Send \'stop\' string to finish.')
    model = pickle.load(open(DEFAULT_MODEL_PATH, 'rb'))
    db_log = Database(DEFAULT_DB_PATH)
    db_log.drop_table()
    while True:
        input_string = input()
        if input_string == 'stop':
            break
        data = json.loads(input_string)
        x = data.popitem()
        df = pd.DataFrame.from_dict(data, orient='index')
        target = x[-1]
        prediction = model.predict_proba(df.T)[:,1]
        np.set_printoptions(suppress=True)
        print(prediction)
        db_log.insert(prediction,target)
    db_log.close()

if __name__ == '__main__':
    main()