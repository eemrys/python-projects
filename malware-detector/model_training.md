```python
%reset -s -f
```


```python
from sklearn.linear_model import LogisticRegression
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.discriminant_analysis import QuadraticDiscriminantAnalysis
from sklearn.naive_bayes import GaussianNB
from sklearn import preprocessing
import pandas as pd
import numpy as np
from sklearn.model_selection import cross_val_score
from sklearn.model_selection import train_test_split
import matplotlib.pyplot as plt
%matplotlib inline
import pickle
from malware_ml.visualization import plot_roc_curve
import warnings
warnings.simplefilter(action='ignore', category=FutureWarning)
```


```python
path_to_data = '/volumes/transcend/data/train.csv'
data = pd.read_csv(path_to_data)
```


```python
models = [
    DecisionTreeClassifier(),
    QuadraticDiscriminantAnalysis(),
    GaussianNB()
]
```


```python
train_val_data, hold_data = train_test_split(data, test_size=0.02, random_state=1)
train_data, val_data = train_test_split(train_val_data, test_size=0.3, random_state=1)
```


```python
hold_data.to_csv('/volumes/transcend/data/hold_data.csv', index=False)
```


```python
train_data.to_csv('/volumes/transcend/data/train_data.csv', index=False)
val_data.to_csv('/volumes/transcend/data/val_data.csv', index=False)
```


```python
train_data = pd.read_csv('/volumes/transcend/data/train_data.csv')
val_data = pd.read_csv('/volumes/transcend/data/val_data.csv')
```

насчет предупреждения: при добавлении параметра low_memory=False бесконечно долго длится процесс чтения файла, пришлось его убрать


```python
columns = train_data.columns
```

### подготовка даты: нужно избавиться от inf, nan, и закодировать данные типа str


```python
from custom import preprocessingData
```


```python
preprocessingData(train_data)
```


```python
preprocessingData(val_data)
```

### сравним cross_val_score для трёх выбранных моделей, но на ограниченной выборке, иначе очень долго (или лучше это вообще убрать?)


```python
for model in models:
    %time print(model, '\nAccuracy:', cross_val_score(model, train_data.iloc[:999999, :-1], train_data.iloc[:999999, -1], cv=3).mean())
    print()
```

### обучение моделей и оценка качества


```python
models[0].fit(train_data[columns[:-1]], train_data[columns[-1]])
```


```python
prediction = models[0].predict_proba(val_data[columns[:-1]])[:,1]
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_data[columns[-1]],
               pred=prediction,
               name='ROC-кривая на валидационном датасете')
```


```python
DecisionTreeClassifier_path = './models/DTC.pkl'
pickle.dump(models[0], open(DecisionTreeClassifier_path, 'wb'))
```


```python
models[1].fit(train_data[columns[:-1]], train_data[columns[-1]])
```


```python
prediction = models[1].predict_proba(val_data[columns[:-1]])[:,1]
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_data[columns[-1]],
               pred=prediction,
               name='ROC-кривая на валидационном датасете')
```


```python
QuadraticDiscriminantAnalysis_path = './models/QDA.pkl'
pickle.dump(models[1], open(QuadraticDiscriminantAnalysis_path, 'wb'))
```


```python
models[2].fit(train_data[columns[:-1]], train_data[columns[-1]])
```


```python
prediction = models[2].predict_proba(val_data[columns[:-1]])[:,1]
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_data[columns[-1]],
               pred=prediction,
               name='ROC-кривая на валидационном датасете')
```


```python
GaussianNB_path = './models/GNB.pkl'
pickle.dump(models[2], open(GaussianNB_path, 'wb'))
```

### из трех рассмотренных моделей лучший результат показала модель QuadraticDiscriminantAnalysis

### попробуем также использовать линейную регрессию и подобрать для неё гиперпараметры


```python
from sklearn.model_selection import GridSearchCV
```


```python
param_grid = dict()
param_grid['C'] = np.power(10.0, np.arange(-2, 2))
param_grid['max_iter'] = range(100,501,100)
param_grid['penalty'] = ['l1','l2']
param_grid['random_state'] = [42];
param_grid['fit_intercept'] = [False, True]
```


```python
LR = LogisticRegression()

print(round(GridSearchCV(LR,  param_grid, cv=5
                        ).fit(train_data[columns[:-1]], train_data[columns[-1]]
                             ).best_score_, 4))
```


```python
prediction = LR.predict_proba(val_data[columns[:-1]])[:,1]
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_data[columns[-1]],
               pred=prediction,
               name='ROC-кривая на валидационном датасете')
```


```python
LR_path = './models/LR.pkl'
pickle.dump(LR, open(LR_path, 'wb'))
```
